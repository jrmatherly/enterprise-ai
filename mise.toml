# mise-en-place configuration for Enterprise AI Platform
# See: https://mise.jdx.dev/
#
# Usage:
#   mise run <task>          # Run a task
#   mise tasks               # List all tasks
#
# Quick Start:
#   mise run setup           # First-time setup (install deps + start Docker + migrate DB)
#   mise run dev             # Start development (Docker + API server)
#   mise run stop            # Stop everything

[tools]
hk = "1.35.0"
pkl = "0.30.2"
python = "3.12"
uv = "latest"

# ============================================
# Environment Configuration
# ============================================
[env]
# Automatically create and activate venv using uv
_.python.venv = { path = ".venv", create = true }

# uv settings
UV_LINK_MODE = "copy"

# ============================================
# Shared Variables
# ============================================
[vars]
docker_compose = "docker compose -f dev/docker-compose.yml"

# ============================================
# Setup & Development
# ============================================

[tasks.setup]
description = "First-time setup: build containers, start Docker, run migrations"
run = """
echo "üê≥ Building and starting Docker stack..."
{{vars.docker_compose}} up -d --build
echo ""
echo "‚è≥ Waiting for services to be ready..."
sleep 10
echo ""
echo "üóÉÔ∏è  Running database migrations..."
{{vars.docker_compose}} exec backend uv run alembic upgrade head
echo ""
echo "‚úÖ Setup complete!"
echo ""
echo "   Frontend: http://localhost:3001"
echo "   Backend:  http://localhost:8000"
echo "   Docs:     http://localhost:8000/docs"
echo "   Langfuse: http://localhost:3000"
"""

[tasks.dev]
description = "Start all services in Docker with hot reload"
run = """
echo "üê≥ Starting all services..."
{{vars.docker_compose}} up -d
echo ""
echo "‚úÖ Services starting!"
echo ""
echo "   Frontend: http://localhost:3001"
echo "   Backend:  http://localhost:8000 (API docs: /docs)"
echo "   Langfuse: http://localhost:3000"
echo ""
echo "üìù View logs with: mise run logs"
echo "üîÑ Hot reload is enabled - edit code and changes apply automatically"
"""

[tasks.dev-local]
description = "Start infra in Docker, run backend/frontend locally (old workflow)"
run = """
echo "üê≥ Starting infrastructure only..."
{{vars.docker_compose}} up -d postgres redis qdrant clickhouse minio langfuse-web langfuse-worker
echo ""
echo "Run these in separate terminals:"
echo "  Backend:  uv run uvicorn src.api.main:app --reload --port 8000"
echo "  Frontend: cd frontend && npm run dev"
"""

[tasks.stop]
description = "Stop all Docker services"
run = "{{vars.docker_compose}} down"

[tasks.restart]
description = "Restart all Docker services (preserves data)"
run = "{{vars.docker_compose}} restart"

[tasks.rebuild]
description = "Rebuild and restart backend/frontend containers"
run = """
echo "üî® Rebuilding backend and frontend..."
{{vars.docker_compose}} up -d --build backend frontend
echo "‚úÖ Containers rebuilt and restarted"
"""

[tasks.logs]
description = "Follow logs from all services"
run = "{{vars.docker_compose}} logs -f"

[tasks.logs-app]
description = "Follow logs from backend and frontend only"
run = "{{vars.docker_compose}} logs -f backend frontend"

[tasks.reset]
description = "Full reset: stop Docker, remove volumes, restart fresh"
confirm = "‚ö†Ô∏è  This will DELETE ALL DATA (databases, caches, uploads). Continue?"
run = """
{{vars.docker_compose}} down -v
{{vars.docker_compose}} up -d --build
echo "‚è≥ Waiting for services..."
sleep 15
{{vars.docker_compose}} exec backend uv run alembic upgrade head
echo "‚úÖ Reset complete!"
"""

# ============================================
# Dependency Management
# ============================================

[tasks.install]
description = "Install production dependencies"
run = "uv sync"
sources = ["pyproject.toml", "uv.lock"]
outputs = [".venv/"]

[tasks.install-dev]
description = "Install all dependencies including dev extras"
run = "uv sync --all-extras"
sources = ["pyproject.toml", "uv.lock"]
outputs = [".venv/"]

[tasks.update]
description = "Update all dependencies to latest compatible versions"
run = "uv sync --upgrade"

# ============================================
# API Server
# ============================================

[tasks.serve]
description = "Run API server (no hot reload, production-like)"
run = "uv run uvicorn src.api.main:app --host 0.0.0.0 --port 8000"

[tasks.serve-reload]
description = "Run API server with hot reload"
run = "uv run uvicorn src.api.main:app --reload --port 8000"

# ============================================
# Code Quality
# ============================================

[tasks.test]
description = "Run tests with pytest"
depends = ["lint"]
run = "uv run pytest"
sources = ["src/**/*.py", "tests/**/*.py", "pyproject.toml"]

[tasks.test-cov]
description = "Run tests with coverage report"
depends = ["lint"]
run = "uv run pytest --cov=src --cov-report=term-missing"
sources = ["src/**/*.py", "tests/**/*.py", "pyproject.toml"]

[tasks.lint]
description = "Run linting with ruff"
run = "uv run ruff check src/"
sources = ["src/**/*.py", "pyproject.toml"]

[tasks.lint-fix]
description = "Run linting and auto-fix issues"
run = "uv run ruff check src/ --fix"

[tasks.format]
description = "Format code with ruff"
run = "uv run ruff format src/"

[tasks.typecheck]
description = "Run type checking with mypy"
run = "uv run mypy src/"
sources = ["src/**/*.py", "pyproject.toml"]

[tasks.check]
description = "Run all checks: lint, format check, typecheck"
depends = ["lint", "typecheck"]
run = """
echo "üé® Checking format..."
uv run ruff format src/ --check
echo ""
echo "‚úÖ All checks passed!"
"""

# ============================================
# Git Hooks (hk)
# ============================================

[tasks.hooks-install]
description = "Install git hooks (pre-commit, commit-msg, pre-push)"
run = "hk install --mise"

[tasks.hooks-check]
description = "Run all hook checks manually (CI-friendly)"
run = "hk run check"

[tasks.hooks-fix]
description = "Run all hook fixes (auto-fix issues)"
run = "hk run fix"

[tasks.pre-commit]
description = "Run pre-commit hook manually"
run = "hk run pre-commit"

# ============================================
# Docker Stack
# ============================================

[tasks.docker-up]
description = "Start Docker development stack"
run = "{{vars.docker_compose}} up -d"

[tasks.docker-down]
description = "Stop Docker development stack"
run = "{{vars.docker_compose}} down"

[tasks.docker-logs]
description = "View Docker logs (follow mode)"
run = "{{vars.docker_compose}} logs -f"

[tasks.docker-ps]
description = "Show Docker container status"
run = "{{vars.docker_compose}} ps"

# ============================================
# Database Migrations (Alembic)
# ============================================

[tasks.db-migrate]
description = "Generate a new migration from model changes (run locally)"
run = "uv run alembic revision --autogenerate -m \"$@\""

[tasks.db-upgrade]
description = "Apply all pending migrations (in container)"
run = "{{vars.docker_compose}} exec backend uv run alembic upgrade head"

[tasks.db-downgrade]
description = "Rollback one migration (in container)"
confirm = "‚ö†Ô∏è  This will rollback the last migration. Continue?"
run = "{{vars.docker_compose}} exec backend uv run alembic downgrade -1"

[tasks.db-history]
description = "Show migration history (in container)"
run = "{{vars.docker_compose}} exec backend uv run alembic history --verbose"

[tasks.db-current]
description = "Show current migration revision (in container)"
run = "{{vars.docker_compose}} exec backend uv run alembic current"

[tasks.db-reset]
description = "Reset database schema (in container)"
confirm = "‚ö†Ô∏è  This will RESET the entire database schema. All data will be LOST. Continue?"
run = "{{vars.docker_compose}} exec backend sh -c 'uv run alembic downgrade base && uv run alembic upgrade head'"

# ============================================
# Utilities
# ============================================

[tasks.shell]
description = "Open Python shell with app context"
run = "uv run python -i -c 'from src.core.config import get_settings; settings = get_settings(); print(f\"Settings loaded: {settings.app_name}\")'"

[tasks.seed]
description = "Seed development data (tenant, user) - in container"
run = "{{vars.docker_compose}} exec backend uv run python scripts/seed_dev_data.py"

[tasks.seed-local]
description = "Seed development data (run locally, for dev-local workflow)"
run = "uv run python scripts/seed_dev_data.py"

# ============================================
# Frontend (Next.js)
# ============================================

[tasks.ui]
description = "Start frontend dev server locally (port 3001) - for dev-local workflow"
run = "cd frontend && npm run dev"

[tasks.ui-install]
description = "Install frontend dependencies locally"
run = "cd frontend && npm install"
sources = ["frontend/package.json", "frontend/package-lock.json"]
outputs = ["frontend/node_modules/"]

[tasks.ui-build]
description = "Build frontend for production (in container)"
run = "{{vars.docker_compose}} exec frontend npm run build"

[tasks.ui-lint]
description = "Lint frontend code (locally)"
run = "cd frontend && npx @biomejs/biome check src/"
sources = ["frontend/src/**/*.{ts,tsx}", "frontend/biome.json"]

[tasks.ui-lint-fix]
description = "Lint and fix frontend code (locally)"
run = "cd frontend && npx @biomejs/biome check --write src/"

[tasks.ui-typecheck]
description = "TypeScript check frontend (locally)"
run = "cd frontend && npx tsc --noEmit"
sources = ["frontend/src/**/*.{ts,tsx}", "frontend/tsconfig.json"]

[tasks.ui-check]
description = "Run all frontend checks: lint + typecheck"
depends = ["ui-lint", "ui-typecheck"]
run = "echo '‚úÖ All frontend checks passed!'"

[tasks.ui-shell]
description = "Open shell in frontend container"
run = "{{vars.docker_compose}} exec frontend sh"

[tasks.backend-shell]
description = "Open shell in backend container"
run = "{{vars.docker_compose}} exec backend bash"

[tasks.chat]
description = "Quick chat test via curl (uses dev bypass)"
run = """
curl -s -X POST http://localhost:8000/api/v1/chat \
  -H "Content-Type: application/json" \
  -H "X-Dev-Bypass: true" \
  -d '{"message": "Hello! What can you help me with?"}' | jq .
"""

# ============================================
# CI Tasks (for GitHub Actions)
# ============================================

[tasks.ci-backend]
description = "Run all backend CI checks"
depends = ["lint", "typecheck", "test"]
run = "echo '‚úÖ Backend CI passed!'"

[tasks.ci-frontend]
description = "Run all frontend CI checks"
depends = ["ui-lint", "ui-typecheck"]
run = "echo '‚úÖ Frontend CI passed!'"

[tasks.ci]
description = "Run full CI pipeline locally"
run = [
    { tasks = ["ci-backend", "ci-frontend"] },  # Run in parallel
    "hk run check",
    "echo '‚úÖ Full CI passed!'",
]
